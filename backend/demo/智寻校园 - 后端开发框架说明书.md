# 智寻校园 - 后端开发框架说明书

## 1. 系统架构设计

### 1.1 整体架构

```
表现层 (Controller) ←→ 业务层 (Service) ←→ 持久层 (Repository)
       ↑                    ↑                    ↑
    Spring Web           Spring AOP         Spring Data JPA
```

### 1.2 技术栈选型

- **核心框架**: Spring Boot 3.x
- **Web 框架**: Spring Web MVC
- **数据持久化**: Spring Data JPA + Hibernate
- **数据库**: PostgreSQL (推荐) / MySQL
- **AOP 支持**: Spring AOP
- **图像识别**: 百度 AI / 腾讯云视觉 / 阿里云视觉
- **地理位置**: 高德地图 API / 百度地图 API
- **文件存储**: 本地存储 + 对象存储(可选)
- **API 文档**: Swagger/OpenAPI 3
- **安全框架**: Spring Security

## 2. 数据库设计

### 2.1 数据库选择

**推荐使用 PostgreSQL**，原因：

- 对地理位置数据支持良好（PostGIS 扩展）
- JSON 类型支持，适合存储图像识别结果
- 性能优秀，开源免费
- 良好的 Spring Boot 集成支持

### 2.2 核心表结构

```sql
-- 用户表
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    role VARCHAR(20) DEFAULT 'USER',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 物品表
CREATE TABLE items (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    image_url VARCHAR(500),
    recognition_result JSONB, -- 图像识别结果
    status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, PUBLISHED, CLAIMED, RETURNED
    found_location GEOMETRY(Point, 4326), -- 地理位置(PostGIS)
    found_time TIMESTAMP,
    publisher_id BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 丢失记录表
CREATE TABLE lost_records (
    id BIGSERIAL PRIMARY KEY,
    item_name VARCHAR(200) NOT NULL,
    description TEXT,
    category VARCHAR(100),
    lost_location GEOMETRY(Point, 4326),
    lost_time TIMESTAMP,
    contact_info VARCHAR(200),
    owner_id BIGINT REFERENCES users(id),
    status VARCHAR(20) DEFAULT 'SEARCHING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 匹配记录表
CREATE TABLE matches (
    id BIGSERIAL PRIMARY KEY,
    item_id BIGINT REFERENCES items(id),
    lost_record_id BIGINT REFERENCES lost_records(id),
    match_score DECIMAL(5,4), -- 匹配度0-1
    match_reason TEXT,
    status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 3. 项目结构设计

```
src/main/java/com/zhixun/campus/
├── config/                 # 配置类
│   ├── WebConfig.java
│   ├── SwaggerConfig.java
│   └── SecurityConfig.java
├── controller/             # 控制层
│   ├── ItemController.java
│   ├── LostRecordController.java
│   ├── MatchController.java
│   └── UserController.java
├── service/                # 业务层
│   ├── impl/
│   ├── ItemService.java
│   ├── LostRecordService.java
│   ├── MatchService.java
│   └── ImageRecognitionService.java
├── repository/             # 数据访问层
│   ├── ItemRepository.java
│   ├── LostRecordRepository.java
│   └── UserRepository.java
├── entity/                 # 实体类
│   ├── User.java
│   ├── Item.java
│   ├── LostRecord.java
│   └── Match.java
├── dto/                    # 数据传输对象
│   ├── request/
│   └── response/
├── aspect/                 # 切面
│   ├── LoggingAspect.java
│   ├── PerformanceAspect.java
│   └── ValidationAspect.java
├── util/                   # 工具类
│   ├── ImageRecognitionUtil.java
│   ├── LocationUtil.java
│   └── MatchAlgorithm.java
└── exception/              # 异常处理
    ├── GlobalExceptionHandler.java
    └── CustomException.java
```

## 4. 核心功能实现

### 4.1 图像识别服务

```java
@Service
public class ImageRecognitionService {

    @Async
    public CompletableFuture<RecognitionResult> recognizeItem(MultipartFile image) {
        // 调用第三方API进行图像识别
        // 返回物品类别、颜色、特征等信息
    }
}
```

### 4.2 智能匹配算法

```java
@Component
public class MatchAlgorithm {

    public double calculateMatchScore(Item item, LostRecord lostRecord) {
        // 1. 文本相似度匹配 (物品名称、描述)
        double textScore = calculateTextSimilarity(
            item.getTitle() + item.getDescription(),
            lostRecord.getItemName() + lostRecord.getDescription()
        );

        // 2. 类别匹配
        double categoryScore = Objects.equals(item.getCategory(),
                                            lostRecord.getCategory()) ? 1.0 : 0.0;

        // 3. 地理位置匹配 (距离计算)
        double locationScore = calculateLocationSimilarity(
            item.getFoundLocation(),
            lostRecord.getLostLocation()
        );

        // 4. 时间匹配
        double timeScore = calculateTimeSimilarity(
            item.getFoundTime(),
            lostRecord.getLostTime()
        );

        // 加权计算最终得分
        return textScore * 0.4 + categoryScore * 0.2 +
               locationScore * 0.3 + timeScore * 0.1;
    }
}
```

### 4.3 AOP 切面应用

```java
@Aspect
@Component
public class LoggingAspect {

    @Around("execution(* com.zhixun.campus.service.*.*(..))")
    public Object logServiceMethods(ProceedingJoinPoint joinPoint) throws Throwable {
        // 记录方法执行日志
        // 性能监控
        // 异常处理
    }
}
```

## 5. API 接口设计

### 5.1 物品相关接口

```
POST /api/items/upload        # 上传物品图片
PUT  /api/items/{id}/publish  # 确认发布物品
GET  /api/items               # 获取物品列表
GET  /api/items/{id}          # 获取物品详情
```

### 5.2 丢失记录接口

```
POST /api/lost-records        # 创建丢失记录
GET  /api/lost-records        # 获取丢失记录列表
PUT  /api/lost-records/{id}   # 更新丢失记录
```

### 5.3 匹配接口

```
GET  /api/matches/items/{itemId}      # 获取物品的匹配建议
GET  /api/matches/lost/{lostRecordId} # 获取丢失记录的匹配建议
POST /api/matches/confirm            # 确认匹配
```

## 6. 配置文件

### application.yml

```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/campus_found
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
  servlet:
    multipart:
      max-file-size: 10MB
      max-request-size: 10MB

# 第三方API配置
ai:
  image-recognition:
    api-key: ${AI_API_KEY}
    secret-key: ${AI_SECRET_KEY}
    endpoint: https://api.ai-service.com/recognize

location:
  api:
    key: ${LOCATION_API_KEY}
    endpoint: https://restapi.amap.com/v3/geocode/geo
```

## 7. 开发计划

### 第一阶段 (1-2 周)

- 项目基础框架搭建
- 数据库设计和实体类创建
- 用户认证授权系统

### 第二阶段 (2-3 周)

- 图像上传和存储功能
- 第三方图像识别 API 集成
- 物品发布流程

### 第三阶段 (2 周)

- 丢失记录管理
- 地理位置服务集成
- 基础匹配算法实现

### 第四阶段 (1-2 周)

- 智能匹配算法优化
- AOP 切面开发
- 系统测试和部署

## 8. 注意事项

1. **安全性考虑**：

   - 文件上传类型检查
   - SQL 注入防护
   - API 访问频率限制
   - 敏感信息加密

2. **性能优化**：

   - 图片压缩处理
   - 数据库索引优化
   - 缓存策略 (Redis)
   - 异步处理耗时操作

3. **扩展性考虑**：
   - 微服务化预留
   - 多图片识别服务商支持
   - 算法可配置化
